<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="bg-background-secondary rounded-xl shadow-sm p-4 mb-4">
    <%= link_to expenses_path, class: "text-primary-accent hover:text-blue-400 font-medium flex items-center" do %>
      <span class="mr-2">‚Üê</span> Back to Expenses ‚Ä¢ <span class="ml-2">Edit Expense</span>
    <% end %>
  </div>

  <!-- Edit Expense Form -->
  <div class="bg-background-secondary rounded-xl shadow-sm p-4">
    <%= form_with model: [@trip, @expense], local: true, class: "space-y-4", 
        data: { controller: "expense-split", action: "submit->expense-split#submitExpenseSplitForm", expense_split_page_value: "edit" } do |form| %>
      
      <!-- Basic Info - Inline Labels and Fields -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex items-center space-x-3">
          <%= form.label :amount, "Amount", class: "text-text-primary font-medium text-sm w-20 flex-shrink-0" %>
          <div class="relative flex-1">
            <%= form.number_field :amount, 
                step: 0.01, placeholder: "25.50", required: true,
                data: { action: "input->expense-split#calculateRemaining" },
                class: "w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-background-primary text-text-primary text-sm" %>
            <span class="absolute right-2 top-2 text-text-secondary text-xs">EUR</span>
          </div>
        </div>
        
        <div class="flex items-center space-x-3">
          <%= form.label :category, "Category", class: "text-text-primary font-medium text-sm w-20 flex-shrink-0" %>
          <%= form.select :category, 
              options_for_select([
                ['üçΩÔ∏è Food', 'food'], ['üè® Hotel', 'accommodation'], 
                ['üöó Transport', 'transport'], ['üéØ Activity', 'activities'],
                ['üõí Shopping', 'shopping'], ['üí∞ Other', 'other']
              ], @expense.category),
              {}, class: "flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-background-primary text-text-primary text-sm" %>
        </div>
        
        <div class="flex items-center space-x-3">
          <%= form.label :payer_id, "Who Paid", class: "text-text-primary font-medium text-sm w-20 flex-shrink-0" %>
          <%= form.select :payer_id, 
              options_for_select(@trip_members.uniq.map { |member| 
                [member.email_address.split('@').first + (member == Current.user ? ' (You)' : ''), member.id] 
              }, @expense.payer.id),
              {}, class: "flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-background-primary text-text-primary text-sm" %>
        </div>
        
        <div class="flex items-center space-x-3">
          <%= form.label :expense_date, "Date", class: "text-text-primary font-medium text-sm w-20 flex-shrink-0" %>
          <%= form.date_field :expense_date, 
              class: "flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-background-primary text-text-primary text-sm" %>
        </div>
      </div>

      <!-- Description -->
      <div class="flex items-center space-x-3">
        <%= form.label :description, "Description", class: "text-text-primary font-medium text-sm w-20 flex-shrink-0" %>
        <%= form.text_field :description, 
            placeholder: "Dinner at Caf√© Central", required: true,
            class: "flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-background-primary text-text-primary text-sm" %>
      </div>

      <!-- Receipt Status -->
      <div class="flex items-center space-x-3">
        <%= form.label :receipt, "Receipt", class: "text-text-primary font-medium text-sm w-20 flex-shrink-0" %>
        <div class="flex-1 flex items-center space-x-3">
          <% if @expense.receipt.attached? %>
            <div class="flex items-center space-x-2">
              <span class="text-green-600 text-sm">‚úì</span>
              <img src="<%= url_for(@expense.receipt) %>" class="h-8 w-8 object-cover rounded border" alt="Current receipt">
            </div>
          <% end %>
          <div class="relative">
            <%= form.file_field :receipt, accept: "image/*", 
                data: { action: "change->expense-split#previewReceipt" },
                class: "absolute inset-0 w-full h-full opacity-0 cursor-pointer" %>
            <button type="button" class="bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-xs border text-text-secondary">
              Choose File
            </button>
          </div>
          <div data-expense-split-target="receiptPreview" class="hidden">
            <img data-expense-split-target="receiptImage" class="h-8 w-8 object-cover rounded border" alt="New receipt preview">
          </div>
        </div>
      </div>

      <!-- Split Type -->
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <h4 class="font-medium text-text-primary">Split Among</h4>
          <div class="flex space-x-3 text-sm">
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="split_type" value="equal" checked
                     data-action="change->expense-split#toggleSplitType"
                     class="mr-1">
              <span>Equal</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="split_type" value="custom" 
                     data-action="change->expense-split#toggleSplitType"
                     class="mr-1">
              <span>Custom</span>
            </label>
          </div>
        </div>
        
        <!-- Equal Split -->
        <div data-expense-split-target="equalSplit">
          <div class="space-y-2 text-sm">
            <% @trip_members.uniq.each do |member| %>
              <% equal_amount = @selected_participant_ids.include?(member.id) ? (@expense.amount / @selected_participant_ids.count) : 0 %>
              <label class="flex items-center justify-between p-2 bg-background-primary rounded border cursor-pointer hover:bg-blue-50">
                <div class="flex items-center">
                  <%= check_box_tag 'expense[participant_ids][]', member.id, 
                      @selected_participant_ids.include?(member.id), 
                      class: "mr-2", data: { action: "change->expense-split#handleEqualAmountUpdate" } %>
                  <%= member.email_address.split('@').first %><%= ' (You)' if member == Current.user %>
                </div>
                <span class="text-right font-medium" data-expense-split-target="equalAmount<%= member.id %>"><%= "%.2f" % equal_amount %> EUR</span>
              </label>
            <% end %>
          </div>
        </div>
        
        <!-- Custom Split -->
        <div data-expense-split-target="customSplit" class="hidden">
          <div class="space-y-2 text-sm">
            <% @trip_members.uniq.each do |member| %>
              <% participant = @expense.expense_participants.find { |p| p.user_id == member.id } %>
              <% is_participant = participant.present? %>
              <div class="flex items-center justify-between p-2 bg-background-primary rounded border"
                   data-expense-split-target="customRow<%= member.id %>">
                <div class="flex items-center">
                  <input type="checkbox" 
                         data-expense-split-target="customParticipant<%= member.id %>"
                         data-action="change->expense-split#toggleCustomParticipant"
                         data-member-id="<%= member.id %>"
                         class="mr-2" <%= 'checked' if is_participant %>>
                  <span><%= member.email_address.split('@').first %><%= ' (You)' if member == Current.user %></span>
                </div>
                <div class="flex items-center">
                  <%= number_field_tag "expense[custom_amounts][#{member.id}]", participant&.amount_owed&.to_s || "0.00", 
                      step: 0.01, min: 0,
                      class: "w-16 p-1 border rounded text-right text-xs",
                      data: { 
                        action: "input->expense-split#calculateRemaining",
                        expense_split_target: "customAmount#{member.id}"
                      } %>
                  <span class="ml-1 text-xs">EUR</span>
                </div>
              </div>
            <% end %>
            <div class="flex justify-between items-center bg-blue-50 p-2 rounded text-xs">
              <button type="button" 
                      data-action="click->expense-split#splitEvenly"
                      class="text-blue-600 hover:text-blue-800 font-medium">
                ‚Üª Split Evenly Among Selected
              </button>
              <div>
                <span>Remaining: </span>
                <span data-expense-split-target="remaining" class="font-bold"><%= "%.2f" % (@expense.amount - @expense.expense_participants.sum(:amount_owed)) %></span> EUR
                <span data-expense-split-target="validationError" class="text-red-600 ml-2 hidden">‚ö† Must equal total</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="flex justify-end space-x-3">
        <%= link_to trip_expenses_path(@trip), class: "px-4 py-2 text-text-secondary hover:text-text-primary" do %>
          Cancel
        <% end %>
        <%= form.submit "Update Expense", 
            class: "bg-primary-accent text-background-primary px-4 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors" %>
      </div>
    <% end %>
  </div>
</div>
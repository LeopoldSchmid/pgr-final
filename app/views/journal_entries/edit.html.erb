<div class="container mx-auto px-4 py-6 max-w-2xl" data-controller="image-preview">
  
  <!-- Header with Back Navigation -->
  <div class="mb-6">
    <%= link_to journal_trip_path(@trip), class: "text-primary-accent hover:text-blue-400 font-medium flex items-center group mb-4" do %>
      <svg class="w-5 h-5 mr-2 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to Journal
    <% end %>
    <h1 class="text-3xl font-bold text-text-primary">Edit Memory</h1>
    <p class="text-text-secondary mt-1">Update your captured moment</p>
  </div>

  <!-- Edit Form -->
  <div class="bg-background-secondary rounded-2xl shadow-lg p-6">
    <%= form_with model: [@trip, @journal_entry], local: true, class: "space-y-4" do |form| %>
      <!-- Hidden field for images to delete -->
      <%= form.hidden_field :images_to_delete, value: "", data: { target: "images-to-delete" } %>
      
      <!-- Current Images Display -->
      <% if @journal_entry.images.attached? %>
        <div class="bg-background-primary rounded-xl p-4 border border-gray-300">
          <h3 class="text-sm font-medium text-text-primary mb-3">Current Photos (<%= @journal_entry.images.count %>)</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3" id="current-images">
            <% @journal_entry.images.each do |image| %>
              <div class="relative group" data-image-id="<%= image.id %>">
                <%= image_tag image.variant(resize_to_limit: [200, 200]), 
                    class: "w-full h-24 object-cover rounded border" %>
                <button type="button"
                        onclick="markImageForDeletion(<%= image.id %>)"
                        class="absolute -top-1 -right-1 w-6 h-6 bg-red-500 text-white rounded-full text-xs font-bold hover:bg-red-600 transition-colors shadow-lg"
                        title="Delete image">
                  √ó
                </button>
              </div>
            <% end %>
          </div>
          <p class="text-xs text-text-secondary">
            <strong>Note:</strong> These photos will be kept unless you upload new ones below. 
            New photos will be <em>added</em> to these existing photos.
          </p>
        </div>
      <% end %>
      
      <!-- Image Upload Section -->
      <div class="bg-background-primary rounded-xl p-4 border-2 border-dashed border-gray-300 hover:border-primary-accent transition-colors">
        <div class="text-center">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <%= form.file_field :images, 
              multiple: true, 
              accept: "image/*",
              data: { 
                action: "change->image-preview#preview",
                image_preview_target: "input" 
              },
              class: "hidden" %>
          <div class="mt-4" data-image-preview-target="uploadButton">
            <label for="<%= form.object_name %>_images" class="cursor-pointer bg-primary-accent text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors inline-flex items-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              <%= @journal_entry.images.attached? ? "Add More Photos" : "Add Photos" %>
            </label>
          </div>
          <p class="mt-2 text-sm text-gray-500" data-image-preview-target="uploadText">
            <%= @journal_entry.images.attached? ? "Upload additional photos (will be added to existing ones)" : "Upload photos to capture this moment" %>
          </p>
        </div>
        
        <!-- Image Previews -->
        <div data-image-preview-target="previewContainer" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-2 hidden">
        </div>
      </div>
      
      <!-- Content Input -->
      <div>
        <%= form.text_area :content, 
            placeholder: "What's happening right now?",
            class: "w-full p-3 bg-background-primary border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary resize-none",
            rows: 3 %>
      </div>
      
      <!-- Location & Options Row -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <!-- Location -->
        <div class="md:col-span-2">
          <%= form.text_field :location, 
              placeholder: "Location name (edit manually)",
              class: "w-full p-3 md:p-2 bg-background-primary border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary text-base md:text-sm",
              autocomplete: "off" %>
        </div>
        
        <!-- Date -->
        <div>
          <%= form.date_field :entry_date, 
              class: "w-full p-2 bg-background-primary border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary text-sm" %>
        </div>
      </div>

      <!-- Favorites Row -->
      <div class="flex items-center space-x-4">
        <label class="flex items-center space-x-2 cursor-pointer">
          <%= form.check_box :favorite, class: "rounded text-yellow-600 focus:ring-yellow-500" %>
          <span class="text-sm font-medium text-text-primary">‚≠ê Favorite</span>
        </label>

        <label class="flex items-center space-x-2 cursor-pointer">
          <%= form.check_box :global_favorite, class: "rounded text-blue-600 focus:ring-blue-500" %>
          <span class="text-sm font-medium text-text-primary">üåç Global Favorite</span>
        </label>
      </div>

      <!-- Advanced Options (Collapsible) -->
      <div class="border-t pt-3">
        <button type="button" 
                onclick="this.nextElementSibling.classList.toggle('hidden')"
                class="text-primary-accent text-sm hover:underline">
          Show coordinates (advanced)
        </button>

        <div class="<%= @journal_entry.has_location? ? '' : 'hidden' %> grid grid-cols-2 gap-2 mt-2">
          <%= form.text_field :latitude, 
              placeholder: "Latitude",
              class: "p-2 bg-background-primary border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary text-sm" %>
          <%= form.text_field :longitude, 
              placeholder: "Longitude",
              class: "p-2 bg-background-primary border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary text-sm" %>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col space-y-3 pt-4">
        <!-- Main Actions -->
        <div class="flex space-x-3">
          <%= link_to journal_trip_path(@trip), class: "flex-1 py-3 px-4 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors text-center" do %>
            Cancel
          <% end %>
          <%= form.submit "Update Memory", 
              class: "flex-2 py-3 px-6 bg-primary-accent text-white rounded-lg font-medium hover:bg-blue-600 transition-colors" %>
        </div>
        
        <!-- Danger Zone -->
        <div class="pt-4 border-t border-gray-300">
          <h3 class="text-sm font-medium text-gray-700 mb-3">Danger Zone</h3>
                    <%= link_to "üóëÔ∏è Delete Memory", trip_journal_entry_path(@trip, @journal_entry), 
              data: { "turbo-method": :delete, confirm: "Are you sure you want to delete this memory? This action cannot be undone and will remove all photos, comments, and votes associated with this entry." },
              class: "w-full py-2 px-4 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors text-center" %>
        </div>
      </div>
    <% end %>
  </div>

</div>

<script>
let imagesToDelete = [];

function markImageForDeletion(imageId) {
  const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
  
  if (imagesToDelete.includes(imageId)) {
    // Unmark - remove from deletion list and restore appearance
    imagesToDelete = imagesToDelete.filter(id => id !== imageId);
    imageElement.style.opacity = '1';
    imageElement.querySelector('button').innerHTML = '√ó';
    imageElement.querySelector('button').className = 'absolute -top-1 -right-1 w-6 h-6 bg-red-500 text-white rounded-full text-xs font-bold hover:bg-red-600 transition-colors shadow-lg';
  } else {
    // Mark for deletion - add to list and gray out
    imagesToDelete.push(imageId);
    imageElement.style.opacity = '0.3';
    imageElement.querySelector('button').innerHTML = '‚Ü∂';
    imageElement.querySelector('button').className = 'absolute -top-1 -right-1 w-6 h-6 bg-gray-500 text-white rounded-full text-xs font-bold hover:bg-gray-600 transition-colors shadow-lg';
  }
  
  // Update hidden field
  document.querySelector('[data-target="images-to-delete"]').value = imagesToDelete.join(',');
}
</script>
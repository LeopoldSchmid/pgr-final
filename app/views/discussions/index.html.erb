<div class="container mx-auto px-4 py-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-text-primary">Discussion Board</h1>
    <%= link_to "← Back to Trip", trip_path(@trip), class: "text-primary-accent hover:underline" %>
  </div>

  <!-- Discussion Posts List -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <% if @discussion_posts.any? %>
      <% @discussion_posts.each do |post| %>
        <div class="border-b border-gray-100 p-3 hover:bg-gray-50 transition-colors duration-150 last:border-b-0 cursor-pointer" 
             onclick="window.location.href='<%= trip_discussion_path(@trip, post) %>'">
          <div class="flex gap-3">
            <!-- Voting -->
            <div class="flex flex-col items-center" onclick="event.stopPropagation()">
              <%= button_to upvote_trip_discussion_path(@trip, post), method: :post, class: vote_button_class(post, 'upvote', Current.user) do %>
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
                </svg>
              <% end %>
              <span class="text-xs font-medium text-gray-700 py-0.5"><%= post.net_votes %></span>
              <%= button_to downvote_trip_discussion_path(@trip, post), method: :post, class: vote_button_class(post, 'downvote', Current.user) do %>
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/>
                </svg>
              <% end %>
            </div>

            <!-- Content -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 text-xs text-gray-500 mb-1">
                <%= user_avatar(post.user, size: 6) %>
                <span class="font-medium"><%= post.user.email_address.split('@').first %></span>
                <span>•</span>
                <span><%= compact_time_ago(post.created_at) %></span>
                <% if post.user == Current.user %>
                  <div class="flex gap-1 ml-auto">
                    <%= link_to edit_trip_discussion_path(@trip, post), class: "text-gray-400 hover:text-gray-600" do %>
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                      </svg>
                    <% end %>
                    <%= link_to trip_discussion_path(@trip, post), method: :delete,
                        confirm: "Are you sure?",
                        class: "text-gray-400 hover:text-red-500" do %>
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    <% end %>
                  </div>
                <% end %>
              </div>
              
              <h3 class="text-base font-medium text-gray-900 mb-1 leading-tight">
                <%= link_to post.title, trip_discussion_path(@trip, post), 
                    class: "hover:text-primary-accent transition-colors" %>
              </h3>
              
              <p class="text-gray-600 text-xs line-clamp-2 mb-1"><%= truncate(post.content, length: 150) %></p>
              
              <div class="flex items-center text-xs text-gray-500">
                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                </svg>
                <span><%= pluralize(post.reply_count, 'comment') %></span>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-8 px-4">
        <p class="text-gray-500 text-sm">No discussions yet. Start the conversation!</p>
      </div>
    <% end %>
  </div>
</div>

<!-- New Discussion Modal -->
<div id="newDiscussionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">New Discussion</h2>
        <button onclick="hideNewDiscussionModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
      
      <%= form_with model: [@trip, @new_discussion_post], url: trip_discussions_path(@trip), local: true, class: "space-y-4" do |form| %>
        <div>
          <%= form.text_field :title, placeholder: "Discussion title...", 
              class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-accent focus:border-transparent" %>
        </div>
        
        <div>
          <%= form.text_area :content, placeholder: "What would you like to discuss?", rows: 4,
              class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-accent focus:border-transparent" %>
        </div>
        
        <div class="flex justify-end gap-3">
          <button type="button" onclick="hideNewDiscussionModal()" 
                  class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200">
            Cancel
          </button>
          <%= form.submit "Start Discussion", 
              class: "bg-primary-accent text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-400 transition-all duration-200" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
function showNewDiscussionModal() {
  document.getElementById('newDiscussionModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function hideNewDiscussionModal() {
  document.getElementById('newDiscussionModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
document.getElementById('newDiscussionModal').addEventListener('click', function(e) {
  if (e.target === this) {
    hideNewDiscussionModal();
  }
});
</script>
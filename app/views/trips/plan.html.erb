<div class="container mx-auto px-4 py-6">
  <!-- Navigation Context Indicator -->
  <%= navigation_context_indicator.html_safe if navigation_context_indicator %>
  
  <!-- Trip Header -->
  <div class="bg-background-secondary rounded-2xl shadow-lg p-6 mb-6"
       data-controller="animate-on-scroll"
       data-animate-on-scroll-animation-class-value="animate-slide-down">
    <div class="mb-4">
      <%= link_to plan_path, class: "text-primary-accent hover:text-blue-400 font-medium flex items-center group mb-3" do %>
        <span class="transform group-hover:-translate-x-1 transition-transform mr-2">←</span> All Planning
      <% end %>
      <h1 class="text-2xl font-bold text-text-primary">
        <%= @trip.name %>
      </h1>
    </div>
    
    <% if @trip.description %>
      <p class="text-text-secondary mb-4 leading-relaxed"><%= @trip.description %></p>
    <% end %>
    
    <div class="flex items-center space-x-3 text-sm">
      <span class="bg-primary-accent text-background-primary px-3 py-1 rounded-lg font-medium">
        Planning
      </span>
      <% if @trip.start_date && @trip.end_date %>
        <span class="text-text-secondary">
          <%= @trip.start_date.strftime("%b %d") %> - <%= @trip.end_date.strftime("%b %d, %Y") %>
        </span>
      <% else %>
        <span class="text-text-secondary">Dates TBD</span>
      <% end %>
    </div>
  </div>

  <!-- Planning Tools -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">

    <!-- Trip Details -->
    <%= link_to edit_trip_path(@trip), class: "bg-background-secondary rounded-xl p-4 shadow-sm hover:shadow-md transition-all transform hover:-translate-y-1", data: { controller: "animate-on-scroll", animate_on_scroll_animation_class_value: "animate-scale-in", animate_on_scroll_delay_value: 100 } do %>
      <div class="text-center">
        <div class="text-2xl mb-2">📅</div>
        <div class="text-sm font-medium text-text-primary">Trip Details</div>
        <div class="text-xs text-text-secondary">Dates & info</div>
      </div>
    <% end %>

    <!-- Meal Planning -->
    <%= link_to trip_recipes_path(@trip), class: "bg-background-secondary rounded-xl p-4 shadow-sm hover:shadow-md transition-all transform hover:-translate-y-1", data: { controller: "animate-on-scroll", animate_on_scroll_animation_class_value: "animate-scale-in", animate_on_scroll_delay_value: 150 } do %>
      <div class="text-center">
        <div class="text-2xl mb-2">🍽️</div>
        <div class="text-sm font-medium text-text-primary">Meal Planning</div>
        <div class="text-xs text-text-secondary"><%= @trip.recipes.count %> recipes</div>
      </div>
    <% end %>

    <!-- Date Proposals -->
    <%= link_to trip_date_proposals_path(@trip), class: "bg-background-secondary rounded-xl p-4 shadow-sm hover:shadow-md transition-all transform hover:-translate-y-1", data: { controller: "animate-on-scroll", animate_on_scroll_animation_class_value: "animate-scale-in", animate_on_scroll_delay_value: 200 } do %>
      <div class="text-center">
        <div class="text-2xl mb-2">🗳️</div>
        <div class="text-sm font-medium text-text-primary">Date Voting</div>
        <div class="text-xs text-text-secondary"><%= @date_proposals.count %> proposals</div>
      </div>
    <% end %>

    <!-- Shopping Lists -->
    <%= link_to trip_shopping_lists_path(@trip), class: "bg-background-secondary rounded-xl p-4 shadow-sm hover:shadow-md transition-all transform hover:-translate-y-1", data: { controller: "animate-on-scroll", animate_on_scroll_animation_class_value: "animate-scale-in", animate_on_scroll_delay_value: 250 } do %>
      <div class="text-center">
        <div class="text-2xl mb-2">🛒</div>
        <div class="text-sm font-medium text-text-primary">Shopping Lists</div>
        <div class="text-xs text-text-secondary">Auto-generated</div>
      </div>
    <% end %>

    <!-- Invitations -->
    <%= link_to trip_invitations_path(@trip), class: "bg-background-secondary rounded-xl p-4 shadow-sm hover:shadow-md transition-all transform hover:-translate-y-1", data: { controller: "animate-on-scroll", animate_on_scroll_animation_class_value: "animate-scale-in", animate_on_scroll_delay_value: 300 } do %>
      <div class="text-center">
        <div class="text-2xl mb-2">✉️</div>
        <div class="text-sm font-medium text-text-primary">Invite People</div>
        <div class="text-xs text-text-secondary">Share planning</div>
      </div>
    <% end %>

    <!-- Discussions -->
    <%= link_to trip_discussions_path(@trip), class: "bg-background-secondary rounded-xl p-4 shadow-sm hover:shadow-md transition-all transform hover:-translate-y-1", data: { controller: "animate-on-scroll", animate_on_scroll_animation_class_value: "animate-scale-in", animate_on_scroll_delay_value: 350 } do %>
      <div class="text-center">
        <div class="text-2xl mb-2">💬</div>
        <div class="text-sm font-medium text-text-primary">Discussions</div>
        <div class="text-xs text-text-secondary"><%= @trip.discussion_posts.count %> topics</div>
      </div>
    <% end %>

    <!-- Trip Series -->
    <% if @related_trips.any? %>
      <div class="bg-background-secondary rounded-xl p-4 shadow-sm">
        <div class="text-center">
          <div class="text-2xl mb-2">🔗</div>
          <div class="text-sm font-medium text-text-primary">Series</div>
          <div class="text-xs text-text-secondary"><%= @related_trips.count %> related</div>
        </div>
      </div>
    <% else %>
      <div class="bg-gray-100 rounded-xl p-4 opacity-50">
        <div class="text-center">
          <div class="text-2xl mb-2">🔗</div>
          <div class="text-sm font-medium text-gray-500">Series</div>
          <div class="text-xs text-gray-400">No series set</div>
        </div>
      </div>
    <% end %>

  </div>

  <!-- Planning Progress Summary -->
  <div class="bg-background-secondary rounded-xl p-4 mb-6"
       data-controller="animate-on-scroll"
       data-animate-on-scroll-animation-class-value="animate-fade-in">
    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
      Planning Progress
    </h3>
    
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="text-center">
        <div class="text-2xl font-bold text-<%= @trip.start_date && @trip.end_date ? 'green' : 'red' %>-600">
          <%= @trip.start_date && @trip.end_date ? '✓' : '○' %>
        </div>
        <div class="text-sm text-text-secondary">Dates Set</div>
      </div>
      
      <div class="text-center">
        <div class="text-2xl font-bold text-<%= @trip.recipes.any? ? 'green' : 'gray' %>-600">
          <%= @trip.recipes.count %>
        </div>
        <div class="text-sm text-text-secondary">Recipes</div>
      </div>
      
      <div class="text-center">
        <div class="text-2xl font-bold text-<%= @date_proposals.any? ? 'green' : 'gray' %>-600">
          <%= @date_proposals.count %>
        </div>
        <div class="text-sm text-text-secondary">Date Options</div>
      </div>
      
      <div class="text-center">
        <div class="text-2xl font-bold text-<%= @trip.trip_members.count > 1 ? 'green' : 'gray' %>-600">
          <%= @trip.trip_members.count %>
        </div>
        <div class="text-sm text-text-secondary">Members</div>
      </div>
    </div>
  </div>

  <!-- Attachments Section -->
  <div class="bg-background-secondary rounded-xl p-4 mb-6" data-controller="attachment-preview animate-on-scroll"
       data-animate-on-scroll-animation-class-value="animate-slide-up">
    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
      Attachments
    </h3>

    <!-- Attachment Upload Form -->
    <%= form_with(model: [@trip, TripAttachment.new], local: true, class: "mb-4", data: { controller: "multi-attachment-form" }) do |form| %>
      <div class="flex flex-col gap-3">
        <div class="flex flex-col sm:flex-row gap-2">
          <%= form.text_field :name, placeholder: "Memory name...", class: "flex-grow bg-background-primary border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-accent focus:border-primary-accent sm:min-w-0", required: true, data: { multi_attachment_form_target: "nameInput" } %>
          <%= form.file_field :files, multiple: true, accept: "image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt,.csv", class: "text-sm text-gray-500 file:mr-2 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary-accent file:text-white hover:file:bg-primary-accent-dark", required: true, data: { multi_attachment_form_target: "fileInput", action: "change->multi-attachment-form#filesSelected" }, onchange: "console.log('File input changed:', this.files); if(this.files.length > 0) { document.querySelector('[data-multi-attachment-form-target=\"uploadButton\"]').textContent = 'Upload ' + this.files.length + ' file' + (this.files.length > 1 ? 's' : ''); }" %>
          <%= form.submit "Upload", class: "bg-primary-accent text-white font-bold py-2 px-4 rounded-md hover:bg-primary-accent-dark cursor-pointer whitespace-nowrap", data: { multi_attachment_form_target: "uploadButton" } %>
        </div>
        
        <!-- File Preview -->
        <div data-multi-attachment-form-target="previewContainer" class="hidden">
          <!-- Preview content will be populated by Stimulus controller -->
        </div>
        
        <!-- Remove Files Button (shown when files are selected) -->
        <button type="button" data-action="multi-attachment-form#removeFiles" class="hidden text-sm text-gray-500 hover:text-gray-700 self-start" data-multi-attachment-form-target="removeButton">
          Remove selected files
        </button>
      </div>
    <% end %>

    <!-- Attachments List -->
    <div class="space-y-4">
      <% @trip.trip_attachments.includes(:user).with_attached_files.each do |attachment| %>
        <% if attachment.files.attached? %>
          <% image_files = attachment.files.select { |file| file.blob.content_type&.start_with?('image/') } %>
          <% other_files = attachment.files.reject { |file| file.blob.content_type&.start_with?('image/') } %>
          
          <div class="bg-background-primary rounded-lg p-4">
            <!-- Attachment Header -->
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2 flex-grow min-w-0">
                <h4 class="font-medium text-text-primary">
                  <span data-attachment-name="<%= attachment.id %>"><%= attachment.name %></span>
                </h4>
                <button onclick="editAttachmentName(<%= attachment.id %>, '<%= attachment.name.gsub("'", "\\'") %>')"
                        class="text-gray-400 hover:text-blue-500 p-1" 
                        title="Edit name">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                  </svg>
                </button>
              </div>
              
              <div class="flex items-center gap-2">
                <!-- Delete Button -->
                <%= button_to trip_trip_attachment_path(@trip, attachment), method: :delete, 
                              data: { confirm: "Are you sure you want to delete this memory and all its files?" },
                              class: "text-gray-400 hover:text-red-500 p-1" do %>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                <% end %>
              </div>
            </div>

            <!-- Image Carousel (if there are images) -->
            <% if image_files.any? %>
              <% 
                image_urls = image_files.map { |file| rails_blob_path(file) }
                image_names = image_files.map { |file| "#{attachment.name} - Image #{image_files.index(file) + 1}" }
                download_urls = image_files.map { |file| rails_blob_path(file, disposition: 'attachment') }
              %>
              
              <div class="mb-4" 
                   data-controller="image-carousel" 
                   data-image-carousel-image-urls-value="<%= image_urls.to_json %>"
                   data-image-carousel-image-names-value="<%= image_names.to_json %>"
                   data-image-carousel-download-urls-value="<%= download_urls.to_json %>">
                
                <!-- Image Counter and Controls -->
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600">
                      <span data-image-carousel-target="imageCounter">1 / <%= image_files.count %></span>
                    </span>
                    <% if image_files.count > 1 %>
                      <span class="text-xs text-gray-500">• Swipe or use arrows to navigate</span>
                    <% end %>
                  </div>
                  <div class="flex items-center gap-2">
                    <button data-action="image-carousel#downloadCurrentImage" 
                            class="text-gray-400 hover:text-blue-500 p-1" 
                            title="Download current image">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                    </button>
                    <button data-action="image-carousel#openFullscreen" 
                            class="text-gray-400 hover:text-blue-500 p-1" 
                            title="View fullscreen">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <!-- Main Carousel Display -->
                <div class="relative bg-gray-50 rounded-lg overflow-hidden" style="height: 300px;">
                  <!-- Main Image Container -->
                  <div data-image-carousel-target="mainImage" 
                       class="w-full h-full flex items-center justify-center cursor-pointer"
                       data-action="click->image-carousel#openFullscreen">
                    <!-- Image will be loaded by controller -->
                  </div>
                  
                  <!-- Navigation Arrows -->
                  <% if image_files.count > 1 %>
                    <button data-image-carousel-target="prevButton"
                            data-action="image-carousel#previousImage" 
                            class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75 transition-opacity">
                      ‹
                    </button>
                    <button data-image-carousel-target="nextButton"
                            data-action="image-carousel#nextImage" 
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75 transition-opacity">
                      ›
                    </button>
                  <% end %>
                </div>
                
                <!-- Thumbnail Strip -->
                <% if image_files.count > 1 %>
                  <div data-image-carousel-target="thumbnailStrip" 
                       class="flex gap-2 mt-3 overflow-x-auto pb-2">
                    <% image_files.each_with_index do |image_file, index| %>
                      <div data-index="<%= index %>" 
                           data-action="click->image-carousel#goToImage"
                           class="flex-shrink-0 cursor-pointer rounded overflow-hidden border-2 border-transparent hover:border-gray-300 transition-colors <%= 'ring-2 ring-blue-500 ring-offset-2' if index == 0 %>">
                        <img src="<%= rails_blob_path(image_file) %>" 
                             alt="Thumbnail <%= index + 1 %>" 
                             class="w-16 h-16 object-cover <%= 'opacity-70' if index != 0 %>">
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Other Files List -->
            <% if other_files.any? %>
              <div class="space-y-2 <%= 'mt-4' if image_files.any? %>">
                <h5 class="text-sm font-medium text-gray-700 mb-2">Documents & Files</h5>
                <% other_files.each do |file| %>
                  <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <div class="flex items-center gap-2 flex-grow min-w-0">
                      <button data-action="attachment-preview#previewFile" 
                              data-file-url="<%= rails_blob_path(file) %>"
                              data-file-name="<%= file.filename %>"
                              data-file-type="<%= file.blob.content_type %>"
                              data-download-url="<%= rails_blob_path(file, disposition: 'attachment') %>"
                              class="text-primary-accent hover:underline text-sm break-all text-left">
                        📄 <%= file.filename %>
                      </button>
                    </div>
                    <div class="flex items-center gap-1">
                      <span class="text-xs text-gray-500">
                        <%= number_to_human_size(file.blob.byte_size) %>
                      </span>
                      <%= link_to rails_blob_path(file, disposition: "attachment"), 
                                  class: "text-gray-400 hover:text-blue-500 p-1", 
                                  title: "Download" do %>
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Attachment Meta -->
            <div class="text-xs text-text-secondary mt-3 pt-2 border-t border-gray-200">
              Uploaded by <%= attachment.user.email_address %> • 
              <%= attachment.files.count %> file<%= 's' if attachment.files.count != 1 %> • 
              <%= number_to_human_size(attachment.files.sum { |f| f.blob.byte_size }) %> total
            </div>

            <!-- Instagram-like Actions -->
            <div class="mt-4 pt-3 border-t border-gray-100">
              <!-- Like Button and Count -->
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-4">
                  <%= button_to trip_trip_attachment_trip_attachment_vote_path(@trip, attachment), method: :post,
                                remote: true,
                                class: "flex items-center space-x-1 text-gray-600 hover:text-red-500 transition-colors #{'text-red-500' if attachment.user_liked?(Current.user)}",
                                data: { 
                                  attachment_id: attachment.id,
                                  turbo_stream: true
                                } do %>
                    <svg class="w-5 h-5 #{'fill-current' if attachment.user_liked?(Current.user)}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                  <% end %>
                  
                  <button class="flex items-center space-x-1 text-gray-600 hover:text-blue-500 transition-colors" onclick="toggleComments('<%= attachment.id %>')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                  </button>
                </div>
                
                <div class="text-sm text-gray-600">
                  <span id="likes-count-<%= attachment.id %>"><%= attachment.likes_count %></span> like<%= 's' unless attachment.likes_count == 1 %>
                  • <%= attachment.comments_count %> comment<%= 's' unless attachment.comments_count == 1 %>
                </div>
              </div>

              <!-- Comments Section -->
              <div id="comments-section-<%= attachment.id %>" class="hidden">
                <!-- Existing Comments -->
                <div class="space-y-2 mb-3">
                  <% attachment.trip_attachment_comments.recent.limit(3).each do |comment| %>
                    <div class="flex items-start space-x-2 text-sm">
                      <span class="font-medium text-gray-700"><%= comment.user.email_address.split('@').first %>:</span>
                      <span class="text-gray-600 flex-1"><%= comment.content %></span>
                      <% if comment.user == Current.user || @trip.user == Current.user %>
                        <%= button_to trip_trip_attachment_trip_attachment_comment_path(@trip, attachment, comment), 
                                      method: :delete,
                                      data: { confirm: "Delete this comment?" },
                                      class: "text-gray-400 hover:text-red-500 text-xs" do %>
                          ×
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                  
                  <% if attachment.comments_count > 3 %>
                    <button class="text-xs text-gray-500 hover:text-gray-700" onclick="loadAllComments('<%= attachment.id %>')">
                      View all <%= attachment.comments_count %> comments
                    </button>
                  <% end %>
                </div>

                <!-- Add Comment Form -->
                <%= form_with model: [@trip, attachment, TripAttachmentComment.new], 
                              local: true,
                              class: "flex items-center space-x-2" do |form| %>
                  <%= form.text_field :content, 
                                    placeholder: "Add a comment...", 
                                    class: "flex-1 text-sm border-none bg-gray-50 rounded-full px-3 py-1 focus:outline-none focus:ring-1 focus:ring-blue-400",
                                    maxlength: 500 %>
                  <%= form.submit "Post", 
                                class: "text-sm text-blue-500 hover:text-blue-700 font-medium px-2 py-1" %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>

    </div>
  </div>

  <!-- Related Trips (if in series) -->
  <% if @related_trips.any? %>
    <div class="bg-background-secondary rounded-xl p-4 mb-6">
      <h3 class="text-lg font-semibold text-text-primary mb-3">Related Trips in "<%= @trip.series_name %>" Series</h3>
      <div class="space-y-2">
        <% @related_trips.limit(3).each do |related_trip| %>
          <%= link_to related_trip, class: "flex items-center justify-between p-3 bg-background-primary rounded-lg hover:shadow-sm transition-shadow" do %>
            <div>
              <div class="font-medium text-text-primary"><%= related_trip.name %></div>
              <div class="text-sm text-text-secondary">
                <%= related_trip.start_date ? related_trip.start_date.strftime("%b %Y") : "Dates TBD" %>
              </div>
            </div>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          <% end %>
        <% end %>
        
        <% if @related_trips.count > 3 %>
          <div class="text-center text-sm text-text-secondary mt-2">
            and <%= @related_trips.count - 3 %> more trips in this series
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

</div>

<!-- Quick Add Modal -->
<div id="quickAddModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Quick Add</h2>
        <button onclick="hideQuickAddModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
      
      <div class="grid grid-cols-1 gap-3">
        <%= link_to new_trip_recipe_path(@trip), class: "flex items-center p-3 bg-orange-50 border border-orange-200 rounded-lg hover:bg-orange-100 transition-colors" do %>
          <div class="text-2xl mr-3">🍽️</div>
          <div>
            <div class="font-medium text-gray-900">Add Recipe</div>
            <div class="text-sm text-gray-600">Plan a meal for this trip</div>
          </div>
        <% end %>
        
        <%= link_to trip_date_proposals_path(@trip), class: "flex items-center p-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors" do %>
          <div class="text-2xl mr-3">🗳️</div>
          <div>
            <div class="font-medium text-gray-900">Date Voting</div>
            <div class="text-sm text-gray-600">View and create date proposals</div>
          </div>
        <% end %>
        
        <%= link_to new_trip_discussion_path(@trip), class: "flex items-center p-3 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors" do %>
          <div class="text-2xl mr-3">💬</div>
          <div>
            <div class="font-medium text-gray-900">Start Discussion</div>
            <div class="text-sm text-gray-600">Create a topic to discuss</div>
          </div>
        <% end %>
        
        <%= link_to new_trip_expense_path(@trip), class: "flex items-center p-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors" do %>
          <div class="text-2xl mr-3">💰</div>
          <div>
            <div class="font-medium text-gray-900">Add Expense</div>
            <div class="text-sm text-gray-600">Track trip expenses</div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
function showQuickAddModal() {
  document.getElementById('quickAddModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function hideQuickAddModal() {
  document.getElementById('quickAddModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
document.getElementById('quickAddModal').addEventListener('click', function(e) {
  if (e.target === this) {
    hideQuickAddModal();
  }
});

// Attachment name editing functions
function editAttachmentName(attachmentId, currentName) {
  const nameSpan = document.querySelector(`[data-attachment-name="${attachmentId}"]`);
  const originalHTML = nameSpan.innerHTML;
  
  // Create input field
  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentName;
  input.className = 'bg-white border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary-accent focus:border-transparent';
  input.style.width = Math.max(currentName.length * 8, 100) + 'px';
  
  // Replace span with input
  nameSpan.innerHTML = '';
  nameSpan.appendChild(input);
  input.focus();
  input.select();
  
  // Save function
  function saveEdit() {
    const newName = input.value.trim();
    if (newName === '' || newName === currentName) {
      nameSpan.innerHTML = originalHTML;
      return;
    }
    
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/trips/<%= @trip.id %>/trip_attachments/${attachmentId}`;
    
    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'PATCH';
    form.appendChild(methodInput);
    
    const tokenInput = document.createElement('input');
    tokenInput.type = 'hidden';
    tokenInput.name = 'authenticity_token';
    tokenInput.value = document.querySelector('meta[name="csrf-token"]').content;
    form.appendChild(tokenInput);
    
    const nameInput = document.createElement('input');
    nameInput.type = 'hidden';
    nameInput.name = 'trip_attachment[name]';
    nameInput.value = newName;
    form.appendChild(nameInput);
    
    document.body.appendChild(form);
    form.submit();
  }
  
  // Cancel function
  function cancelEdit() {
    nameSpan.innerHTML = originalHTML;
  }
  
  // Event listeners
  input.addEventListener('blur', saveEdit);
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      saveEdit();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      cancelEdit();
    }
  });
}

// Instagram-like functionality
function toggleComments(attachmentId) {
  const commentsSection = document.getElementById(`comments-section-${attachmentId}`);
  if (commentsSection.classList.contains('hidden')) {
    commentsSection.classList.remove('hidden');
  } else {
    commentsSection.classList.add('hidden');
  }
}

function loadAllComments(attachmentId) {
  // This could be implemented later to load all comments via AJAX
  console.log(`Loading all comments for attachment ${attachmentId}`);
}
</script>

<!-- Attachment Preview Modal -->
<div id="attachment-modal" class="fixed inset-0 backdrop-blur-md bg-black bg-opacity-40 hidden items-center justify-center z-50" data-controller="attachment-preview">
  <div class="relative max-w-4xl max-h-full p-4 w-full mx-4">
    <div class="bg-white rounded-2xl shadow-xl p-6">
      <!-- Modal Header -->
      <div class="flex items-center justify-between mb-4">
        <h3 id="attachment-modal-title" class="text-lg font-semibold text-gray-900 truncate mr-4 flex-1 min-w-0"></h3>
        <div class="flex items-center gap-2">
          <!-- Download Button -->
          <a id="attachment-download-link" href="#" download 
             class="inline-flex items-center px-3 py-1 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition-colors">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Download
          </a>
          <!-- Close Button -->
          <button data-action="attachment-preview#closeModal" 
                  class="text-gray-400 hover:text-gray-600 p-1 rounded-md transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Modal Content -->
      <div id="attachment-modal-content" class="overflow-auto max-h-96">
        <!-- Content will be populated by Stimulus controller -->
      </div>
    </div>
  </div>
</div>
<div class="container mx-auto px-4 py-6">
  <!-- Navigation Context Indicator -->
  <%= navigation_context_indicator.html_safe if navigation_context_indicator %>
  
  <!-- Trip Header -->
  <div class="bg-background-secondary rounded-2xl shadow-lg p-8 mb-8">
    <div class="mb-6">
      <%= link_to go_path, class: "text-primary-accent hover:text-yellow-400 font-medium flex items-center group mb-4" do %>
        <span class="transform group-hover:-translate-x-1 transition-transform mr-2">🎒</span> Active Trips
      <% end %>
      <h1 class="text-3xl font-bold text-text-primary">
        <%= @trip.name %>
      </h1>
    </div>
    
    <div class="flex items-center space-x-4">
      <span class="bg-primary-accent text-background-primary px-4 py-2 rounded-xl text-sm font-bold shadow-md">
        🏃 Active
      </span>
      <% if @trip.start_date && @trip.end_date %>
        <span class="text-text-secondary font-medium">
          📅 <%= @trip.start_date.strftime("%b %d") %> - <%= @trip.end_date.strftime("%b %d, %Y") %>
        </span>
      <% end %>
      <span class="text-text-secondary font-medium">
        🌟 Day <%= (@trip.start_date ? (Date.current - @trip.start_date).to_i + 1 : 1) %> of trip
      </span>
    </div>
  </div>

  <!-- Trip Journal -->
  <div class="mb-8">
    <!-- Add New Journal Entry -->
    <div class="bg-background-secondary rounded-2xl shadow-lg p-8 mb-6">
      <h3 class="text-xl font-bold text-text-primary mb-6 flex items-center">
        <span class="mr-3">📝</span> Capture This Moment
      </h3>
      
      <%= form_with model: [@trip, @new_journal_entry], local: true, class: "space-y-6", data: { controller: "location image-preview entry-template" } do |form| %>
        <!-- Template Selection -->
        <div class="bg-background-primary rounded-xl p-4">
          <h4 class="font-semibold text-text-primary mb-2">✨ Use a Template</h4>
          <div class="flex space-x-2">
            <button type="button" 
                    data-action="click->entry-template#applyTemplate" 
                    data-entry-template-type-param="food"
                    class="bg-primary-accent text-background-primary px-4 py-2 rounded-lg font-medium hover:bg-yellow-400 transition-colors text-sm">
              🍽️ Food
            </button>
            <button type="button" 
                    data-action="click->entry-template#applyTemplate" 
                    data-entry-template-type-param="activity"
                    class="bg-primary-accent text-background-primary px-4 py-2 rounded-lg font-medium hover:bg-yellow-400 transition-colors text-sm">
              🎯 Activity
            </button>
            <button type="button" 
                    data-action="click->entry-template#applyTemplate" 
                    data-entry-template-type-param="accommodation"
                    class="bg-primary-accent text-background-primary px-4 py-2 rounded-lg font-medium hover:bg-yellow-400 transition-colors text-sm">
              🏨 Accommodation
            </button>
          </div>
        </div>

        <!-- Main Content -->
        <div>
          <%= form.text_area :content, 
              placeholder: "What are you doing right now? Where are you? How does it feel? 🌟",
              inputmode: "text",
              autocapitalize: "sentences",
              spellcheck: "true",
              data: { entry_template_target: "contentField" },
              class: "w-full p-4 bg-background-primary border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary resize-none text-lg",
              rows: 4 %>
        </div>
        
        <!-- Location Section -->
        <div class="bg-background-primary rounded-xl p-4 space-y-4">
          <h4 class="font-semibold text-text-primary">📍 Location</h4>
          
          <!-- Current Location Button -->
          <button type="button" 
                  data-location-target="button" 
                  data-action="click->location#getCurrentLocation"
                  class="bg-primary-accent text-background-primary px-4 py-2 rounded-lg font-medium hover:bg-yellow-400 transition-colors text-sm">
            📍 Use Current Location
          </button>
          
          <!-- Location Name -->
          <div class="relative">
            <%= form.text_field :location, 
                placeholder: "Name this place (e.g., 'Central Park', 'That amazing cafe')",
                data: { location_target: "locationName", action: "input->location#search" },
                class: "w-full p-3 bg-background-primary border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary" %>
            <div data-location-target="autocompleteResults" class="absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg mt-1">
              <!-- Autocomplete results will be appended here -->
            </div>
          </div>

          <!-- Category Selection -->
          <div>
            <%= form.label :category, "Category (optional)", class: "block text-text-secondary font-medium mb-1" %>
            <%= form.select :category, 
                options_for_select([
                  ["Select Category", nil],
                  "restaurant", 
                  "hotel", 
                  "attraction", 
                  "transport", 
                  "shopping", 
                  "other"
                ], @new_journal_entry.category),
                {},
                data: { entry_template_target: "categoryField" },
                class: "w-full p-3 bg-background-primary border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary" %>
          </div>
          
          <!-- Coordinate Fields -->
          <div>
            <%= form.label :latitude, "Latitude", class: "block text-text-secondary font-medium mb-1" %>
            <%= form.text_field :latitude, 
                data: { location_target: "latitude" },
                class: "w-full p-3 bg-background-primary border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary" %>
          </div>
          <div>
            <%= form.label :longitude, "Longitude", class: "block text-text-secondary font-medium mb-1" %>
            <%= form.text_field :longitude, 
                data: { location_target: "longitude" },
                class: "w-full p-3 bg-background-primary border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary" %>
          </div>
        </div>
        
        <!-- Date and Favorite -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
          <div>
            <%= form.label :entry_date, class: "block text-text-secondary font-medium mb-1" %>
            <%= form.date_field :entry_date, 
                class: "w-full p-3 bg-background-primary border border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-accent text-text-primary" %>
          </div>
          
          <label class="flex items-center p-3 bg-yellow-900 bg-opacity-50 rounded-xl border border-yellow-700 cursor-pointer">
            <%= form.check_box :favorite, class: "mr-3 rounded scale-125" %>
            <span class="text-yellow-300 font-semibold">⭐ Mark as favorite moment</span>
          </label>

          <label class="flex items-center p-3 bg-blue-900 bg-opacity-50 rounded-xl border border-blue-700 cursor-pointer">
            <%= form.check_box :global_favorite, class: "mr-3 rounded scale-125" %>
            <span class="text-blue-300 font-semibold">🌍 Mark as global favorite location</span>
          </label>
        </div>
        
        <!-- Submit Button -->
        <div class="text-center">
          <%= form.submit "📝 Capture This Memory", 
              class: "bg-primary-accent text-background-primary px-8 py-4 rounded-xl font-bold hover:bg-yellow-400 transition-all duration-200 shadow-lg transform hover:scale-105 text-lg" %>
        </div>
      <% end %>
    </div>

    <!-- Journal Entries -->
    <% if @journal_entries.any? %>
      <div class="space-y-6" data-controller="bulk-actions" data-bulk-actions-trip-id="<%= @trip.id %>">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-text-primary flex items-center">
            <span class="mr-3">📖</span> Trip Journal
          </h3>
          <div class="flex items-center space-x-4">
            <label class="flex items-center text-text-secondary">
              <input type="checkbox" data-action="bulk-actions#toggleAll" class="mr-2 rounded"> Select All
            </label>
            <button type="button" 
                    data-action="bulk-actions#deleteSelected" 
                    data-bulk-actions-target="deleteButton"
                    class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition-colors text-sm hidden">
              Delete Selected
            </button>
            <button type="button" 
                    data-action="bulk-actions#exportSelected" 
                    data-bulk-actions-target="exportButton"
                    class="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors text-sm hidden">
              Export Selected
            </button>
          </div>
        </div>
        
        <%= form_with url: bulk_destroy_trip_journal_entries_path(@trip), method: :delete, data: { bulk_actions_target: "form" } do |f| %>
          <% @journal_entries.each do |entry| %>
            <div class="bg-background-secondary rounded-2xl shadow-lg p-6 <%= entry.favorite? ? 'ring-2 ring-yellow-400' : '' %>">
              <div class="flex items-start justify-between mb-4">
                <div class="flex items-center space-x-3">
                  <input type="checkbox" name="journal_entry_ids[]" value="<%= entry.id %>" data-action="bulk-actions#toggleEntry" class="mr-2 rounded">
                  <div class="text-text-secondary font-bold">
                    <%= entry.entry_date.strftime("%b %d") %>
                  </div>
                  <div class="text-text-secondary text-sm">
                    by <%= entry.user.email_address %>
                  </div>
                  <% if entry.location_name %>
                    <div class="text-text-secondary text-sm bg-background-primary px-3 py-1 rounded-full">
                      <%= entry.location_name %>
                    </div>
                  <% end %>
                  <% if entry.favorite? %>
                    <div class="text-yellow-400">⭐</div>
                  <% end %>
                </div>
                
                <div class="flex space-x-2">
                  <%= link_to toggle_favorite_trip_journal_entry_path(@trip, entry), method: :patch, 
                      class: "text-yellow-400 hover:text-yellow-500 #{entry.favorite? ? 'opacity-100' : 'opacity-50'}" do %>
                    ⭐
                  <% end %>
                  <%= link_to trip_journal_entry_path(@trip, entry), method: :delete, 
                      class: "text-red-500 hover:text-red-400 text-sm",
                      data: { confirm: "Delete this journal entry?" } do %>
                    🗑️
                  <% end %>
                </div>
              </div>
              
              <!-- Entry Images -->
              <% if entry.images.attached? %>
                <div class="mb-4 flex flex-wrap gap-2">
                  <% entry.images.each do |image| %>
                    <%= image_tag image.variant(resize_to_limit: [800, 800], quality: 80), class: "w-full h-64 object-cover rounded-xl shadow-md" %>
                  <% end %>
                </div>
              <% end %>
              
              <!-- Entry Content -->
              <div class="text-text-primary leading-relaxed mb-4">
                <%= format_journal_content(entry.content) %>
              </div>
              
              <!-- Entry Footer -->
              <div class="flex items-center justify-between text-xs text-text-secondary">
                <span>Added <%= time_ago_in_words(entry.created_at) %> ago</span>
                <% if entry.has_location? %>
                  <span class="bg-background-primary px-2 py-1 rounded-full">
                    🗺️ Mapped
                  </span>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="bg-background-secondary rounded-2xl shadow-lg p-12">
        <div class="text-center">
          <div class="text-6xl mb-4 opacity-60">📖</div>
          <h3 class="text-xl font-bold text-text-primary mb-3">Start Your Trip Journal</h3>
          <p class="text-text-secondary mb-6">Capture the moments, feelings, and discoveries as they happen. Your future self will thank you! 🌟</p>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Memory Map -->
  <% if @journal_entries.with_location.any? %>
    <div class="mb-8">
      <h3 class="text-xl font-bold text-text-primary mb-6 flex items-center">
        <span class="mr-3">🗺️</span> Memory Map
      </h3>
      
      <div class="bg-background-secondary rounded-2xl shadow-lg p-6">
        <div id="trip-map" 
             class="h-96 rounded-xl"
             data-controller="map" 
             data-map-entries-value="<%= @journal_entries.with_location.map do |entry|
               {
                 id: entry.id,
                 latitude: entry.latitude.to_f,
                 longitude: entry.longitude.to_f,
                 content: entry.content,
                 location: entry.location,
                 entry_date: entry.entry_date.iso8601,
                 favorite: entry.favorite?,
                 image_url: entry.image.attached? ? rails_blob_path(entry.image, only_path: true) : nil
               }
             end.to_json %>"
             data-map-target="container">
        </div>
        
        <div class="mt-4 text-sm text-text-secondary flex items-center justify-between">
          <span>📍 <%= @journal_entries.with_location.count %> memories mapped</span>
          <span>⭐ Starred memories, 📍 Regular memories</span>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Quick Actions for Active Trip -->
  <div class="mt-8 bg-background-secondary rounded-lg p-6">
    <h3 class="text-lg font-semibold text-text-primary mb-4">Quick Actions</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <%= link_to new_trip_expense_path(@trip), class: "flex flex-col items-center p-4 bg-background-primary rounded-lg shadow-sm hover:shadow-md transition-shadow" do %>
        <span class="text-2xl mb-2">💰</span>
        <span class="text-sm font-medium text-text-secondary">Add Expense</span>
      <% end %>
      <button class="flex flex-col items-center p-4 bg-background-primary rounded-lg shadow-sm hover:shadow-md transition-shadow">
        <span class="text-2xl mb-2">🛒</span>
        <span class="text-sm font-medium text-text-secondary">Check List</span>
      </button>
      <%= link_to trip_expenses_path(@trip), class: "flex flex-col items-center p-4 bg-background-primary rounded-lg shadow-sm hover:shadow-md transition-shadow" do %>
        <span class="text-2xl mb-2">📊</span>
        <span class="text-sm font-medium text-text-secondary">View Expenses</span>
      <% end %>
      <button class="flex flex-col items-center p-4 bg-background-primary rounded-lg shadow-sm hover:shadow-md transition-shadow">
        <span class="text-2xl mb-2">⏰</span>
        <span class="text-sm font-medium text-text-secondary">Set Reminder</span>
      </button>
    </div>
  </div>

  <!-- End Trip Option -->
  <div class="mt-8 text-center">
    <button class="bg-gray-700 text-white px-6 py-2 rounded-lg font-medium hover:bg-gray-600 transition-colors">
      End Trip
    </button>
  </div>
</div>
